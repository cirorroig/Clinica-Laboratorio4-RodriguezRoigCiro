<main class="mt-5 pt-5">
  <div class="container mt-4">
    <form [formGroup]="registrationForm" class="form-signin w-100 m-auto">
      <img class="mb-4" src="logo.png" alt="" width="100" height="100">
      <h1 class="h3 mb-3 fw-normal">Registro</h1>

      <!-- Selección de tipo de usuario -->
      <div class="mb-3">
        <label class="form-label">Tipo de Usuario</label>
        <div class="btn-group w-100" role="group">
          <button type="button" class="btn" [class.btn-primary]="userType === 'patient'"
            [class.btn-outline-primary]="userType !== 'patient'" (click)="onUserTypeChange('patient')">
            Paciente
          </button>
          <button type="button" class="btn" [class.btn-primary]="userType === 'specialist'"
            [class.btn-outline-primary]="userType !== 'specialist'" (click)="onUserTypeChange('specialist')">
            Especialista
          </button>
        </div>
      </div>

      <!-- Campos comunes -->
      <div class="form-floating mb-3">
        <input formControlName="nombre" type="text" class="form-control" id="nombre" placeholder="Nombre">
        <label for="nombre">Nombre</label>
        <div class="invalid-feedback" *ngIf="registrationForm.get('nombre')?.invalid && registrationForm.get('nombre')?.touched">
          El nombre es requerido y debe tener al menos 2 caracteres
        </div>
      </div>

      <div class="form-floating mb-3">
        <input formControlName="apellido" type="text" class="form-control" id="apellido" placeholder="Apellido">
        <label for="apellido">Apellido</label>
        <div class="invalid-feedback" *ngIf="registrationForm.get('apellido')?.invalid && registrationForm.get('apellido')?.touched">
          El apellido es requerido y debe tener al menos 2 caracteres
        </div>
      </div>

      <div class="form-floating mb-3">
        <input formControlName="edad" type="number" class="form-control" id="edad" placeholder="Edad">
        <label for="edad">Edad</label>
        <div class="invalid-feedback" *ngIf="registrationForm.get('edad')?.invalid && registrationForm.get('edad')?.touched">
          La edad debe estar entre 18 y 120 años
        </div>
      </div>

      <div class="form-floating mb-3">
        <input formControlName="dni" type="text" class="form-control" id="dni" placeholder="DNI">
        <label for="dni">DNI</label>
        <div class="invalid-feedback" *ngIf="registrationForm.get('dni')?.invalid && registrationForm.get('dni')?.touched">
          El DNI debe tener 8 dígitos
        </div>
      </div>

      <!-- Campos específicos para pacientes -->
      @if (userType === 'patient') {
        <div class="form-floating mb-3">
          <input formControlName="obraSocial" type="text" class="form-control" id="obraSocial" placeholder="Obra Social">
          <label for="obraSocial">Obra Social</label>
          <div class="invalid-feedback" *ngIf="registrationForm.get('obraSocial')?.invalid && registrationForm.get('obraSocial')?.touched">
            La obra social es requerida
          </div>
        </div>
      }

      <!-- Campos específicos para especialistas -->
      @if (userType === 'specialist') {
        <div class="mb-3">
          <label class="form-label">Especialidad</label>
          <select formControlName="especialidad" class="form-select mb-2">
            <option value="">Seleccione una especialidad</option>
            @for (specialty of specialties; track specialty) {
              <option [value]="specialty">{{specialty}}</option>
            }
          </select>
          
          <div class="input-group">
            <input [(ngModel)]="newSpecialty" [ngModelOptions]="{standalone: true}" type="text" class="form-control" 
              placeholder="Nueva especialidad">
            <button class="btn btn-outline-secondary" type="button" (click)="addSpecialty()">
              Agregar
            </button>
          </div>
        </div>
      }

      <!-- Campos de autenticación -->
      <div class="form-floating mb-3">
        <input formControlName="email" type="email" class="form-control" id="email" placeholder="name@example.com">
        <label for="email">Correo electrónico</label>
        <div class="invalid-feedback" *ngIf="registrationForm.get('email')?.invalid && registrationForm.get('email')?.touched">
          Ingrese un correo electrónico válido
        </div>
      </div>

      <div class="form-floating mb-3">
        <input formControlName="password" type="password" class="form-control" id="password" placeholder="Contraseña">
        <label for="password">Contraseña</label>
        <div class="invalid-feedback" *ngIf="registrationForm.get('password')?.invalid && registrationForm.get('password')?.touched">
          La contraseña debe tener al menos 6 caracteres
        </div>
      </div>

      <!-- Carga de imágenes -->
      <div class="mb-3">
        <label class="form-label">Imágenes de perfil</label>
        @if (userType === 'patient') {
          <div class="d-flex gap-2">
            <div class="flex-grow-1">
              <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event, 0)">
            </div>
            <div class="flex-grow-1">
              <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event, 1)">
            </div>
          </div>
        } @else {
          <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event, 0)">
        }
      </div>

      @if (errorMessage) {
        <div class="alert alert-danger" role="alert">
          {{ errorMessage }}
        </div>
      }

      <button (click)="registro()" class="btn btn-primary w-100 py-2" [disabled]="registrationForm.invalid || isLoading">
        @if (isLoading) {
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Registrando...
        } @else {
          Registrarse
        }
      </button>
    </form>
  </div>
</main>
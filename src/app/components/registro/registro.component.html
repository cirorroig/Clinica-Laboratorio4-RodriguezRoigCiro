<main class="mt-5 pt-5">
  <div class="container mt-4">
    <form [formGroup]="registrationForm" class="form-signin w-100 m-auto">
      <div class="text-center mb-4">
        <h1 class="h3 mb-3 fw-normal">Registro</h1>
      </div>

      <!-- Selección de tipo de usuario -->
      <div class="mb-4">
        <label class="form-label">Tipo de Usuario</label>
        <div class="btn-group w-100" role="group">
          <button type="button" class="btn" [class.btn-primary]="userType === 'patient'"
            [class.btn-outline-primary]="userType !== 'patient'" (click)="onUserTypeChange('patient')">
            Paciente
          </button>
          <button type="button" class="btn" [class.btn-primary]="userType === 'specialist'"
            [class.btn-outline-primary]="userType !== 'specialist'" (click)="onUserTypeChange('specialist')">
            Especialista
          </button>
        </div>
      </div>

      <div class="row">
        <!-- Columna izquierda -->
        <div class="col-md-6">
          <!-- Campos personales -->
          <div class="form-floating mb-3">
            <input formControlName="nombre" type="text" class="form-control" id="nombre" placeholder="Nombre"
              [class.is-invalid]="registrationForm.get('nombre')?.invalid && registrationForm.get('nombre')?.touched">
            <label for="nombre">Nombre</label>
            @if (registrationForm.get('nombre')?.invalid && registrationForm.get('nombre')?.touched) {
              <div class="invalid-feedback d-block">
                El nombre es requerido y debe tener al menos 2 caracteres
              </div>
            }
          </div>

          <div class="form-floating mb-3">
            <input formControlName="apellido" type="text" class="form-control" id="apellido" placeholder="Apellido"
              [class.is-invalid]="registrationForm.get('apellido')?.invalid && registrationForm.get('apellido')?.touched">
            <label for="apellido">Apellido</label>
            @if (registrationForm.get('apellido')?.invalid && registrationForm.get('apellido')?.touched) {
              <div class="invalid-feedback d-block">
                El apellido es requerido y debe tener al menos 2 caracteres
              </div>
            }
          </div>

          <div class="form-floating mb-3">
            <input formControlName="edad" type="number" class="form-control" id="edad" placeholder="Edad"
              [class.is-invalid]="registrationForm.get('edad')?.invalid && registrationForm.get('edad')?.touched">
            <label for="edad">Edad</label>
            @if (registrationForm.get('edad')?.invalid && registrationForm.get('edad')?.touched) {
              <div class="invalid-feedback d-block">
                @if (userType === 'patient') {
                  La edad debe estar entre 1 y 100 años
                } @else {
                  La edad debe estar entre 23 y 100 años
                }
              </div>
            }
          </div>

          <div class="form-floating mb-3">
            <input formControlName="dni" type="text" class="form-control" id="dni" placeholder="DNI"
              [class.is-invalid]="registrationForm.get('dni')?.invalid && registrationForm.get('dni')?.touched">
            <label for="dni">DNI</label>
            @if (registrationForm.get('dni')?.invalid && registrationForm.get('dni')?.touched) {
              <div class="invalid-feedback d-block">
                El DNI debe tener 8 dígitos
              </div>
            }
          </div>

          <!-- Campos específicos según tipo de usuario -->
          @if (userType === 'patient') {
            <div class="form-floating mb-3">
              <input formControlName="obraSocial" type="text" class="form-control" id="obraSocial" placeholder="Obra Social"
                [class.is-invalid]="registrationForm.get('obraSocial')?.invalid && registrationForm.get('obraSocial')?.touched">
              <label for="obraSocial">Obra Social</label>
              @if (registrationForm.get('obraSocial')?.invalid && registrationForm.get('obraSocial')?.touched) {
                <div class="invalid-feedback d-block">
                  La obra social es requerida
                </div>
              }
            </div>
          }

          @if (userType === 'specialist') {
            <div class="mb-3">
              <label class="form-label">Especialidad</label>
              <select formControlName="especialidad" class="form-select mb-2"
                [class.is-invalid]="registrationForm.get('especialidad')?.invalid && registrationForm.get('especialidad')?.touched">
                <option value="">Seleccione una especialidad</option>
                @for (specialty of specialties; track specialty) {
                  <option [value]="specialty">{{specialty}}</option>
                }
              </select>
              @if (registrationForm.get('especialidad')?.invalid && registrationForm.get('especialidad')?.touched) {
                <div class="invalid-feedback d-block">
                  La especialidad es requerida
                </div>
              }
              
              <div class="input-group">
                <input [(ngModel)]="newSpecialty" [ngModelOptions]="{standalone: true}" type="text" class="form-control" 
                  placeholder="Nueva especialidad">
                <button class="btn btn-outline-secondary" type="button" (click)="addSpecialty()">
                  Agregar
                </button>
              </div>
            </div>
          }
        </div>

        <!-- Columna derecha -->
        <div class="col-md-6">
          <!-- Campos de autenticación -->
          <div class="form-floating mb-3">
            <input formControlName="email" type="email" class="form-control" id="email" placeholder="name@example.com"
              [class.is-invalid]="registrationForm.get('email')?.invalid && registrationForm.get('email')?.touched">
            <label for="email">Correo electrónico</label>
            @if (registrationForm.get('email')?.invalid && registrationForm.get('email')?.touched) {
              <div class="invalid-feedback d-block">
                Ingrese un correo electrónico válido
              </div>
            }
          </div>

          <div class="form-floating mb-3">
            <input formControlName="password" type="password" class="form-control" id="password" placeholder="Contraseña"
              [class.is-invalid]="registrationForm.get('password')?.invalid && registrationForm.get('password')?.touched">
            <label for="password">Contraseña</label>
            @if (registrationForm.get('password')?.invalid && registrationForm.get('password')?.touched) {
              <div class="invalid-feedback d-block">
                La contraseña debe tener al menos 6 caracteres
              </div>
            }
          </div>

          <!-- Carga de imágenes -->
          <div class="mb-3">
            <label class="form-label">Imágenes de perfil</label>
            @if (userType === 'patient') {
              <div class="d-flex flex-column gap-2">
                <div>
                  <label class="form-label small text-muted">Primera imagen</label>
                  <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event, 0)">
                </div>
                <div>
                  <label class="form-label small text-muted">Segunda imagen</label>
                  <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event, 1)">
                </div>
              </div>
            } @else {
              <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event, 0)">
            }
          </div>
        </div>
      </div>

      @if (errorMessage) {
        <div class="alert alert-danger mt-3" role="alert">
          {{ errorMessage }}
        </div>
      }
      @if (successMessage) {
        <div class="alert alert-success mt-3" role="alert">
          {{ successMessage }}
        </div>
      }
      <button (click)="registro()" class="btn btn-primary w-100 py-2 mt-3" [disabled]="registrationForm.invalid || isLoading">
        @if (isLoading) {
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Registrando...
        } @else {
          Registrarse
        }
      </button>
    </form>
  </div>
</main>